
#include "LookTable.h"

struct Node{
	float voltage;
	float level;
};

const struct Node looktable[] = {
{4080.4	,100},
{4070.2	,99.96},
{4027.1	,98.88},
{4006.6	,97.88},
{3990.5	,96.92},
{3977.2	,95.96},
{3962.6	,94.84},
{3951.5	,93.88},
{3940.6	,92.92},
{3930.4	,91.92},
{3920.2	,90.96},
{3909	,89.84},
{3899.1	,88.88},
{3889.8	,87.92},
{3880.5	,86.96},
{3871.2	,85.96},
{3861.2	,84.88},
{3852.3	,83.88},
{3843.9	,82.92},
{3834.9	,81.96},
{3825.6	,80.84},
{3817.8	,79.88},
{3809.8	,78.92},
{3802	,77.92},
{3794.6	,76.96},
{3785.9	,75.84},
{3778.8	,74.88},
{3771.7	,73.92},
{3764.8	,72.92},
{3758.3	,71.96},
{3750.9	,70.84},
{3744.7	,69.88},
{3738.5	,68.92},
{3732.6	,67.96},
{3727	,66.96},
{3720.8	,65.88},
{3715.5	,64.88},
{3710.6	,63.92},
{3705.3	,62.96},
{3699.7	,61.84},
{3694.8	,60.88},
{3689.8	,59.92},
{3685.2	,58.92},
{3680.2	,57.96},
{3674.9	,56.84},
{3670.3	,55.88},
{3665.6	,54.92},
{3661.3	,53.96},
{3657.3	,52.96},
{3652.6	,51.88},
{3648.6	,50.88},
{3644.5	,49.92},
{3640.8	,48.96},
{3637.1	,47.96},
{3633.1	,46.88},
{3629.7	,45.88},
{3626.6	,44.92},
{3623.2	,43.96},
{3619.4	,42.84},
{3616.6	,41.88},
{3613.5	,40.92},
{3610.4	,39.92},
{3607.7	,38.96},
{3604.6	,37.84},
{3601.1	,36.88},
{3598	,35.92},
{3594.9	,34.96},
{3591.8	,33.96},
{3588.1	,32.88},
{3584.7	,31.88},
{3581	,30.92},
{3577.6	,29.96},
{3573.2	,28.84},
{3569.5	,27.88},
{3565.5	,26.92},
{3561.5	,25.92},
{3556.8	,24.96},
{3551.8	,23.84},
{3547.5	,22.88},
{3542.9	,21.92},
{3537.9	,20.92},
{3533.2	,19.96},
{3527.7	,18.84},
{3522.4	,17.88},
{3516.2	,16.92},
{3509.7	,15.96},
{3502.6	,14.96},
{3492.9	,13.88},
{3484.3	,12.88},
{3474	,11.92},
{3462.9	,10.96},
{3448.3	,9.84},
{3432.8	,8.88},
{3416.1	,7.92},
{3395	,6.92},
{3370.2	,5.96},
{3336.1	,4.84},
{3298.3	,3.88},
{3251.7	,2.92},
{3193.8	,1.96},
{3118.1	,0.96},
};

/** 
 * 二分查找法，找到对应ADC值的数组下标 
 * 注意：原数据为逆序存放，经典二分查找算法要修改一下。
 */
static int get_index(float voltage)
{
	float min = voltage-looktable[0].voltage;
	if ( min < 0 ) min *= -1;
	
	int idx = 0;
	
	for ( int i = 0; i < (sizeof(looktable)/sizeof(looktable[0])); i++ )
	{
		float temp = voltage-looktable[i].voltage;
		if ( temp < 0 ) temp *= -1;
		if ( min > temp )
		{
			min = temp;
			idx = i;
		}
	}
    
    /* 若没有查找到，则返回最临近的 */
    return idx;
}

/**
 * 根据下标在温度值数组中取得对应温度值。
 */
static float getTvalue(int index)
{ 
  return looktable[index].level;
}
   

/**
* 外部调用接口
*/
float getBattery(float voltage)
{
    int idx;
    
    idx = get_index( voltage );
    
    return getTvalue(idx);
}

